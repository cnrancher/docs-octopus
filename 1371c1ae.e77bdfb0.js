(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{141:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return p}));var a=n(2),i=n(9),r=(n(0),n(186)),o={id:"adaptor",title:"How it Works"},c={id:"en/adaptors/adaptor",title:"How it Works",description:"## Design of Adaptor",source:"@site/docs/en/adaptors/_index.md",permalink:"/docs-octopus/docs/en/adaptors/adaptor",editUrl:"https://github.com/cnrancher/docs-octopus/edit/master/website/docs/en/adaptors/_index.md",sidebar:"docs",previous:{title:"State of DeviceLink",permalink:"/docs-octopus/docs/en/devicelink/state-of-dl"},next:{title:"Modbus Adaptor",permalink:"/docs-octopus/docs/en/adaptors/modbus"}},s=[{value:"Design of Adaptor",id:"design-of-adaptor",children:[]},{value:"Adaptor APIs",id:"adaptor-apis",children:[]},{value:"Available Adaptor List",id:"available-adaptor-list",children:[]}],b={rightToc:s};function p(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(r.b)("wrapper",Object(a.a)({},b,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("h2",{id:"design-of-adaptor"},"Design of Adaptor"),Object(r.b)("p",null,"The Octopus was born with strong scalability in mind, this ability reflects in the design of the device model and the adaptor especially."),Object(r.b)("p",null,"Since device model can be defined via CRD, the device model can either be a dedicated device such as a fan, LED, etc., or a general protocol device such as a Bluetooth, Modbus, OPC-UA device, and etc."),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                      \u2502   MideaAirPurifier   \u2502 #dedicated device model\n                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                                     \n                                                     \n                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                      \u2502 MideaAirConditioning \u2502 #dedicated device model\n                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                             \n                                             \n                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                      \u2502  XiaoMiAirPurifier   \u2502 #dedicated device model\n                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                             \n\n                      \u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n                      \u2551      Bluetooth       \u2551  #protocol device model\n                      \u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n\n                                             \n                      \u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n                      \u2551        Modbus        \u2551 #protocol device model\n                      \u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n\n                                             \n                      \u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n                      \u2551        OPC-UA        \u2551 #protocol device model\n                      \u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n")),Object(r.b)("p",null,"At the meantime, the implementation of adapter can be connected to a single device or multiple devices:"),Object(r.b)("pre",null,Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"                                         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                           \n                              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502   MideaAirPurifier   \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                \n                              \u2502          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502                                \n                              \u2502                                            \u2502                                \n                              \u2502                                            \u2502                                \n                   .          \u2502          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502           .                    \n                  ( )\u25c0\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524          \u2502 MideaAirConditioning \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6( )                   \n                   '          \u2502          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                      '                    \n   adaptors.smarthome.io/airpurifier                                      adaptors.media.io/smarthome       \n                              \u2502                                                                             \n                              \u2502          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                           \n                              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2502  XiaoMiAirPurifier   \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                \n                                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518          \u2502                                \n                                                                           \u2502                                \n                                                                           \u2502                                \n                                         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510          \u2502            .                   \n                                         \u2502 XiaoMiWeighingScale  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25b6( )                  \n                                         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                       '                   \n                                                                          adaptors.xiaomi.io/smarthome      \n                                                                                                            \n                   .                     \u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557                                           \n                  ( )\u25c0\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2551      Bluetooth       \u2551                                           \n                   '                     \u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d                                           \n    adaptors.edge.cattle.io/ble                                                                       \n                                                                                                            \n                                         \u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557                       .                   \n                                         \u2551        Modbus        \u2551\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u25b6( )                  \n                                         \u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d                       '                   \n                                                                         adaptors.edge.cattle.io/modbus     \n")),Object(r.b)("p",null,"Please view ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"/docs-octopus/docs/en/develop"}),"here")," for more detail about developing an adaptor."),Object(r.b)("h2",{id:"adaptor-apis"},"Adaptor APIs"),Object(r.b)("p",null,"The access management of adaptors takes inspiration from ",Object(r.b)("a",Object(a.a)({parentName:"p"},{href:"https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/"}),"Kubernetes Device Plugins management"),". The available version of access management APIs is ",Object(r.b)("inlineCode",{parentName:"p"},"v1alpha1"),"."),Object(r.b)("table",null,Object(r.b)("thead",{parentName:"table"},Object(r.b)("tr",{parentName:"thead"},Object(r.b)("th",Object(a.a)({parentName:"tr"},{align:"center"}),"Versions"),Object(r.b)("th",Object(a.a)({parentName:"tr"},{align:"center"}),"Available"),Object(r.b)("th",Object(a.a)({parentName:"tr"},{align:"center"}),"Current"))),Object(r.b)("tbody",{parentName:"table"},Object(r.b)("tr",{parentName:"tbody"},Object(r.b)("td",Object(a.a)({parentName:"tr"},{align:"center"}),Object(r.b)("a",Object(a.a)({parentName:"td"},{href:"./design_of_adaptor.md"}),Object(r.b)("inlineCode",{parentName:"a"},"v1alpha1"))),Object(r.b)("td",Object(a.a)({parentName:"tr"},{align:"center"}),"*"),Object(r.b)("td",Object(a.a)({parentName:"tr"},{align:"center"}),"*")))),Object(r.b)("p",null,"Use the following steps to make the adaptor interact with ",Object(r.b)("inlineCode",{parentName:"p"},"limb"),":"),Object(r.b)("ol",null,Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"The ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," starts a gRPC service with a Unix socket on host path to receive registration requests from adaptors:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-proto"}),"// Registration is the service advertised by the Limb,\n// any adaptor start its service until Limb approved this register request.\nservice Registration {\n    rpc Register (RegisterRequest) returns (Empty) {}\n}\n\nmessage RegisterRequest {\n    // Name of the adaptor in the form `adaptor-vendor.com/adaptor-name`.\n    string name = 1;\n    // Version of the API the adaptor was built against.\n    string version = 2;\n    // Name of the unix socket the adaptor is listening on, it's in the form `*.sock`.\n    string endpoint = 3;\n}\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"The adaptor starts a gRPC service with a Unix socket under host path ",Object(r.b)("inlineCode",{parentName:"p"},"/var/lib/octopus/adaptors"),", that implements the following interfaces:"),Object(r.b)("pre",{parentName:"li"},Object(r.b)("code",Object(a.a)({parentName:"pre"},{className:"language-proto"}),"// Connection is the service advertised by the adaptor.\nservice Connection {\n    rpc Connect (stream ConnectRequest) returns (stream ConnectResponse) {}\n}\n\nmessage ConnectRequestReferenceEntry {\n    map<string, bytes> items = 1;\n}\n\nmessage ConnectRequest {\n    // [Deprecated] Parameters for the connection, it's in form JSON bytes.\n    bytes parameters = 1;\n    // Model for the device.\n    k8s.io.apimachinery.pkg.apis.meta.v1.TypeMeta model = 2;\n    // Desired device, it's in form JSON bytes.\n    bytes device = 3;\n    // References for the device, i.e: Secret, ConfigMap and Downward API.\n    map<string, ConnectRequestReferenceEntry> references = 4;\n}\n\nmessage ConnectResponse {\n    // Observed device, it's in form JSON bytes.\n    bytes device = 1;\n}\n"))),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"The adaptor registers itself with the ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," through the Unix socket at host path ",Object(r.b)("inlineCode",{parentName:"p"},"/var/lib/octopus/adaptors/limb.sock"),".")),Object(r.b)("li",{parentName:"ol"},Object(r.b)("p",{parentName:"li"},"After successfully registering itself, the adaptor runs in serving mode, during which it keeps connecting devices and reports back to the ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," upon any device state changes."))),Object(r.b)("h4",{id:"registration"},"Registration"),Object(r.b)("p",null,"The ",Object(r.b)("strong",{parentName:"p"},"Registration")," can let the ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," to know the existence of an adaptor/, on this phase, the ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," acts as a server, and the adaptor acts as a client. The adaptor constructs a registration request with its ",Object(r.b)("inlineCode",{parentName:"p"},"name"),", ",Object(r.b)("inlineCode",{parentName:"p"},"version")," and accessing ",Object(r.b)("inlineCode",{parentName:"p"},"endpoint"),", and then request to ",Object(r.b)("inlineCode",{parentName:"p"},"limb"),". After successfully registered, the ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," will keep watching the adaptor and notify those DeviceLinks related to the registered adaptor."),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"name")," is the name of the adaptor, it's strongly recommended that to use this pattern ",Object(r.b)("inlineCode",{parentName:"li"},"adaptor-vendor.com/adaptor-name")," to named an adaptor, each adaptor must have one unique ",Object(r.b)("inlineCode",{parentName:"li"},"name"),".",Object(r.b)("blockquote",{parentName:"li"},Object(r.b)("p",{parentName:"blockquote"},"The second adaptor who has the same ",Object(r.b)("inlineCode",{parentName:"p"},"name")," will overwrite the previous one."))),Object(r.b)("li",{parentName:"ul"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"version")," is the API version of accessing management, for now, it's fixed in ",Object(r.b)("inlineCode",{parentName:"li"},"v1alpha1"),"."),Object(r.b)("li",{parentName:"ul"},"The accessing ",Object(r.b)("inlineCode",{parentName:"li"},"endpoint")," is the name of the UNIX socket, each adaptor must have one unique ",Object(r.b)("inlineCode",{parentName:"li"},"endpoint"),". ",Object(r.b)("blockquote",{parentName:"li"},Object(r.b)("p",{parentName:"blockquote"},"The second adaptor who has the same registered ",Object(r.b)("inlineCode",{parentName:"p"},"endpoint")," will never register successfully until the previous one quits.")))),Object(r.b)("h4",{id:"connection"},"Connection"),Object(r.b)("p",null,"The ",Object(r.b)("strong",{parentName:"p"},"Connection")," can let the ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," to connect to an adaptor, on this phase, the adaptor acts as a server, and the ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," acts as a client. The ",Object(r.b)("inlineCode",{parentName:"p"},"limb")," constructs a connection request with the ",Object(r.b)("inlineCode",{parentName:"p"},"parameters"),", ",Object(r.b)("inlineCode",{parentName:"p"},"model"),", ",Object(r.b)("inlineCode",{parentName:"p"},"device")," and ",Object(r.b)("inlineCode",{parentName:"p"},"references"),", and then request to the target adaptor."),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"parameters")," are the parameters used for connection, it's in form JSON bytes.",Object(r.b)("blockquote",{parentName:"li"},Object(r.b)("p",{parentName:"blockquote"},"This ",Object(r.b)("inlineCode",{parentName:"p"},"parameters")," field has been ",Object(r.b)("strong",{parentName:"p"},"DEPRECATED"),", it should define the connection parameter as a part of the device model."))),Object(r.b)("li",{parentName:"ul"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"model")," is the device's model, it's useful to help adaptor to distinguish multiple models, or maintain the compatibility if there are different versions in one model."),Object(r.b)("li",{parentName:"ul"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"device")," is the device's instance, it's in form JSON bytes, which is JSON bytes of a complete ",Object(r.b)("inlineCode",{parentName:"li"},"model")," instance and contains ",Object(r.b)("inlineCode",{parentName:"li"},"spec")," and ",Object(r.b)("inlineCode",{parentName:"li"},"status")," data.",Object(r.b)("blockquote",{parentName:"li"},Object(r.b)("p",{parentName:"blockquote"},"The adaptor should select the corresponding deserialized receiving object according to the ",Object(r.b)("inlineCode",{parentName:"p"},"model")," to receive this field's data.\nSince the receiving object (device instance) is a legal CRD instance, it strictly conforms to the resource management convention of Kubernetes, so a device can be uniquely identified by Namespace and Name."))),Object(r.b)("li",{parentName:"ul"},"The ",Object(r.b)("inlineCode",{parentName:"li"},"references")," is the reference sources of the device, it allows the device to use the ConfigMap and Secret under the same Namespace, or downward API of the parent DeviceLink instance.")),Object(r.b)("h2",{id:"available-adaptor-list"},"Available Adaptor List"),Object(r.b)("ul",null,Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"./modbus"}),"Modbus")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"./opc-ua"}),"OPC-UA")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"./mqtt"}),"MQTT")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"./ble"}),"BLE")),Object(r.b)("li",{parentName:"ul"},Object(r.b)("a",Object(a.a)({parentName:"li"},{href:"./dummy"}),"Dummy"))))}p.isMDXComponent=!0},186:function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return u}));var a=n(0),i=n.n(a);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var b=i.a.createContext({}),p=function(e){var t=i.a.useContext(b),n=t;return e&&(n="function"==typeof e?e(t):c({},t,{},e)),n},l=function(e){var t=p(e.components);return i.a.createElement(b.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},m=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,o=e.parentName,b=s(e,["components","mdxType","originalType","parentName"]),l=p(n),m=a,u=l["".concat(o,".").concat(m)]||l[m]||d[m]||r;return n?i.a.createElement(u,c({ref:t},b,{components:n})):i.a.createElement(u,c({ref:t},b))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=m;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,o[1]=c;for(var b=2;b<r;b++)o[b]=n[b];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);